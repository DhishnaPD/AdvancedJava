<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%>
<%@ page import="javax.servlet.*"%>   
<%@ page import="java.sql.*, java.util.*, java.io.*"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/sql" prefix="sql" %>
<%@ page import="org.apache.commons.fileupload.servlet.ServletFileUpload" %>
<%@ page import="org.apache.commons.fileupload.FileItemFactory" %>
<%@ page import="org.apache.commons.fileupload.disk.DiskFileItemFactory" %>
<%@ page import="org.apache.commons.fileupload.FileItem" %>

<html>
<head>
    <meta charset="ISO-8859-1">
    <title>File Upload</title>
</head>
<body>
<%
    File file = null;
    int maxMemorySize = 5000 * 1024; // 5MB
    int maxFileSize = 5000 * 1024;   // 5MB
    String uploadDirectory = "/uploads/"; // Relative path for upload directory

    String contentType = request.getContentType();
    String fieldName = null;
    String fileName = null;
    int affectedRows = 0;

    if (contentType.indexOf("multipart/form-data") >= 0) {
        DiskFileItemFactory diskFileItemFactory = new DiskFileItemFactory();
        diskFileItemFactory.setSizeThreshold(maxMemorySize);
        diskFileItemFactory.setRepository(new File(uploadDirectory));

        ServletFileUpload upload = new ServletFileUpload(diskFileItemFactory);
        upload.setSizeMax(maxFileSize);

        try {
            List<FileItem> fileItems = upload.parseRequest(request); // Specify generic type for FileItem
            Iterator<FileItem> iterator = fileItems.iterator();

            while (iterator.hasNext()) {
                FileItem fileItem = iterator.next();
                if (!fileItem.isFormField()) {
                    fieldName = fileItem.getFieldName();
                    fileName = fileItem.getName();
                    boolean isInMemory = fileItem.isInMemory();
                    long sizeInBytes = fileItem.getSize();

                    // Get the upload path dynamically (relative path or absolute path based on server)
                    String uploadPath = getServletContext().getRealPath("") + uploadDirectory;

                    file = new File(uploadPath + fileName);

                    fileItem.write(file); // Save the uploaded file

                    out.println("File written successfully at: " + file.getAbsolutePath());
                }
            }
        } catch (Exception e) {
            out.println("Error during file upload: " + e.getMessage());
            e.printStackTrace();
        }

        // Insert file path into the database
        if (file != null && fileName != null) {
            Connection connection = null;
            PreparedStatement preparedStatement = null;

            try {
                Class.forName("com.mysql.cj.jdbc.Driver");  // Use the appropriate driver for MySQL 8
                connection = DriverManager.getConnection("jdbc:mysql://localhost/java1", "root", "root");

                // Insert the file path into the database
                preparedStatement = connection.prepareStatement("INSERT INTO images(image) VALUES(?)");
                String relativePath = uploadDirectory + fileName; // Store relative path in DB
                preparedStatement.setString(1, relativePath);

                affectedRows = preparedStatement.executeUpdate();
            } catch (SQLException e) {
                out.println("Database error: " + e.getMessage());
            } catch (ClassNotFoundException e) {
                out.println("Database driver error: " + e.getMessage());
            } finally {
                try {
                    if (connection != null) {
                        connection.close();
                    }
                    if (preparedStatement != null) {
                        preparedStatement.close();
                    }
                } catch (SQLException e) {
                    out.println("Error closing database resources: " + e.getMessage());
                }
            }

            if (affectedRows > 0) {
                out.println("Image uploaded successfully to the database.");
            } else {
                out.println("Failed to upload image to the database.");
            }
        }
    } else {
        out.println("Request is not of type 'multipart/form-data'.");
    }
%>

<c:redirect url="index.jsp"></c:redirect>

</body>
</html>
